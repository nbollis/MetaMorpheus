<UserControl x:Class="MetaMorpheusGUI.ParallelSearchParamsControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MetaMorpheusGUI"
             xmlns:guiFunctions="clr-namespace:GuiFunctions;assembly=GuiFunctions" 
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800" MaxHeight="600">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisConverter"/>
       
        <!-- Import styling from App.xaml for consistency -->
        <Style x:Key="ImportantButtonStyle" TargetType="Button">
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Width" Value="200"/>
            <Setter Property="Background" Value="{StaticResource AccentColor}"/>
            <Setter Property="Foreground" Value="{StaticResource TextColor2}"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <!-- DataGrid styling for transient databases -->
        <Style x:Key="DataGridStyle" TargetType="DataGrid">
            <Setter Property="Foreground" Value="{StaticResource TextColor1}"/>
            <Setter Property="Background" Value="{StaticResource DataGridBackgroundColor}"/>
            <Setter Property="Height" Value="Auto"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource BorderColor}"/>
            <Setter Property="Margin" Value="10,0,10,10"/>
            <Setter Property="SelectedItem" Value="{Binding SelectedRow, Mode=TwoWay}"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="HorizontalGridLinesBrush" Value="{StaticResource DataGridHeaderColor}"/>
            <Setter Property="VerticalGridLinesBrush" Value="{StaticResource DataGridHeaderColor}"/>
            <Setter Property="AutoGenerateColumns" Value="False"/>
        </Style>

        <Style x:Key="DataGridColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="{StaticResource DataGridHeaderColor}"/>
            <Setter Property="FontSize" Value="13" />
        </Style>

        <!--<Style x:Key="DatabaseDataGridItemStyle" TargetType="DataGridRow">
            <EventSetter Event="Selected" Handler="AddSelectedTransientDatabase" />
            <EventSetter Event="Unselected" Handler="RemoveSelectedTransientDatabase" />
        </Style>

        <Style x:Key="DataGridCellStyle" TargetType="DataGridCell">
            <EventSetter Event="MouseDoubleClick" Handler="Row_DoubleClick"/>
        </Style>-->
    </UserControl.Resources>

    <Grid IsEnabled="{Binding IsEnabled}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto" MinHeight="120"/>
        </Grid.RowDefinitions>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Options Row 1 -->
        <StackPanel Orientation="Horizontal" Margin="5 5 5 0" Grid.Row="0" Grid.Column="0">
            <CheckBox x:Name="OverwriteTransientResultsCheckBox"
                      Content="Overwrite existing transient results files"
                      IsChecked="{Binding OverwriteTransientResults}"
                      ToolTipService.ShowDuration="999999"
                      ToolTipService.InitialShowDelay="500">
                <CheckBox.ToolTip>
                    <TextBlock>
                        If results files from prior Many Search runs exist, overwrite them.
                        <LineBreak />
                        If unchecked, existing results will be preserved and skipped.
                    </TextBlock>
                </CheckBox.ToolTip>
            </CheckBox>
        </StackPanel>

        <!-- Options Row 2 -->
        <StackPanel Orientation="Horizontal" Margin="5 5 5 0" Grid.Row="1" Grid.Column="0">
            <CheckBox x:Name="WriteTransientResultsOnlyCheckBox"
                      Content="Write Transient Results Only"
                      IsChecked="{Binding WriteTransientResultsOnly}"/>
        </StackPanel>

        <!-- Options Row 3 -->
        <StackPanel Orientation="Horizontal" Margin="5 5 5 0" Grid.Row="2" Grid.Column="0">
            <CheckBox x:Name="WriteTransientSpectralLibraryCheckBox"
                      Content="Write Transient Result Spectral Library"
                      IsChecked="{Binding WriteTransientSpectralLibrary}"/>
        </StackPanel>

        <!-- Options Row 4 -->
        <StackPanel Orientation="Horizontal" Margin="5 5 5 0" Grid.Row="3" Grid.Column="0">
            <CheckBox x:Name="CompressTransientCheckbox"
                      Content="Compress transient results files"
                      IsChecked="{Binding CompressTransientResults}"
                      ToolTipService.ShowDuration="999999"
                      ToolTipService.InitialShowDelay="500">
                <CheckBox.ToolTip>
                    <TextBlock>
                        Compress files after transient database searching is complete to save disk space.
                    </TextBlock>
                </CheckBox.ToolTip>
            </CheckBox>
        </StackPanel>

        <!-- Max Parallel Searches -->
        <StackPanel Orientation="Horizontal" Margin="5 0 5 0" Grid.Row="0" Grid.Column="1"
                    Grid.RowSpan="2" VerticalAlignment="Top">
            <Label x:Name="ParallelSearchesLabel" Content="Max Parallel Searches:"
                   VerticalAlignment="Center" />
            <TextBox x:Name="MaxParallelSearchesTextBox" Width="45"
                     Text="{Binding MaxSearchesInParallel}"
                     HorizontalContentAlignment="Center"
                     ToolTipService.ShowDuration="999999"
                     ToolTipService.InitialShowDelay="500">
                <TextBox.ToolTip>
                    <TextBlock>
                        The maximum number of parallel searches to run when Many Search is enabled.
                        <LineBreak />
                        This is limited by available CPU and RAM.
                    </TextBlock>
                </TextBox.ToolTip>
            </TextBox>
        </StackPanel>

        <!-- Test Ratio for Writing -->
        <StackPanel Orientation="Horizontal" Margin="5 0 5 0" Grid.Row="2" Grid.Column="1"
                    Grid.RowSpan="2" VerticalAlignment="Top">
            <Label x:Name="TestRatioLabel" Content="Test Pass Ratio for Writing:"
                   VerticalAlignment="Center"
                   ToolTipService.ShowDuration="999999"
                   ToolTipService.InitialShowDelay="500">
                <Label.ToolTip>
                    <TextBlock>
                        Minimum ratio of statistical tests that must pass for an organism
                        <LineBreak />
                        to be included in follow-up database generation (0.0 - 1.0).
                    </TextBlock>
                </Label.ToolTip>
            </Label>
            <TextBox x:Name="TestRatioTextBox" Width="45"
                     Text="{Binding TestRatioForWriting}"
                     HorizontalContentAlignment="Center"
                     ToolTipService.ShowDuration="999999"
                     ToolTipService.InitialShowDelay="500">
                <TextBox.ToolTip>
                    <TextBlock>
                        Enter a value between 0.0 and 1.0
                        <LineBreak />
                        (e.g., 0.5 means at least 50% of tests must pass)
                    </TextBlock>
                </TextBox.ToolTip>
            </TextBox>
        </StackPanel>

        <!-- Follow-Up Database Generation GroupBox -->
        <GroupBox Header="Follow-Up Database Generation" 
                  Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="2"
                  Margin="5,5,5,5"
                  BorderBrush="{StaticResource BorderColor}"
                  BorderThickness="1">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Header Row -->
                <TextBlock Grid.Row="0" Grid.Column="0" 
                           Text="Database Type" 
                           FontWeight="Bold" 
                           Margin="5,5,5,10"
                           VerticalAlignment="Center"/>
                <TextBlock Grid.Row="0" Grid.Column="1" 
                           Text="Write FASTA" 
                           FontWeight="Bold" 
                           Margin="5,5,5,10"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
                <TextBlock Grid.Row="0" Grid.Column="2" 
                           Text="Search" 
                           FontWeight="Bold" 
                           Margin="5,5,5,10"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>

                <!-- All Significant Organisms Row -->
                <TextBlock Grid.Row="1" Grid.Column="0" 
                           Text="All Proteins from Significant Organisms"
                           Margin="5,5,5,5"
                           VerticalAlignment="Center"
                           ToolTipService.ShowDuration="999999"
                           ToolTipService.InitialShowDelay="500">
                    <TextBlock.ToolTip>
                        <TextBlock>
                            Includes ALL proteins from organisms that pass the significance threshold.
                            <LineBreak />
                            This creates the largest database.
                        </TextBlock>
                    </TextBlock.ToolTip>
                </TextBlock>
                <CheckBox Grid.Row="1" Grid.Column="1"
                          IsChecked="{Binding WriteAllSignificantOrganisms}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                <CheckBox Grid.Row="1" Grid.Column="2"
                          IsChecked="{Binding SearchAllSignificantOrganisms}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          IsEnabled="{Binding WriteAllSignificantOrganisms}"/>

                <!-- Detected Proteins Row -->
                <TextBlock Grid.Row="2" Grid.Column="0" 
                           Text="Detected Proteins Only"
                           Margin="5,5,5,5"
                           VerticalAlignment="Center"
                           ToolTipService.ShowDuration="999999"
                           ToolTipService.InitialShowDelay="500">
                    <TextBlock.ToolTip>
                        <TextBlock>
                            Includes only proteins that were detected (protein groups)
                            <LineBreak />
                            from significant organisms. More refined than 'All Proteins'.
                        </TextBlock>
                    </TextBlock.ToolTip>
                </TextBlock>
                <CheckBox Grid.Row="2" Grid.Column="1"
                          IsChecked="{Binding WriteDetectedProteins}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                <CheckBox Grid.Row="2" Grid.Column="2"
                          IsChecked="{Binding SearchDetectedProteins}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          IsEnabled="{Binding WriteDetectedProteins}"/>

                <!-- Detected Peptides Row -->
                <TextBlock Grid.Row="3" Grid.Column="0" 
                           Text="Proteins with Detected Peptides"
                           Margin="5,5,5,5"
                           VerticalAlignment="Center"
                           ToolTipService.ShowDuration="999999"
                           ToolTipService.InitialShowDelay="500">
                    <TextBlock.ToolTip>
                        <TextBlock>
                            Includes proteins that had at least one detected peptide
                            <LineBreak />
                            from significant organisms. Most refined database.
                        </TextBlock>
                    </TextBlock.ToolTip>
                </TextBlock>
                <CheckBox Grid.Row="3" Grid.Column="1"
                          IsChecked="{Binding WriteDetectedPeptides}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                <CheckBox Grid.Row="3" Grid.Column="2"
                          IsChecked="{Binding SearchDetectedPeptides}"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"
                          IsEnabled="{Binding WriteDetectedPeptides}"/>
            </Grid>
        </GroupBox>

        <!-- Instructions text with dynamic count -->
        <StackPanel Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2" Margin="5,10,5,5">
            <TextBlock TextWrapping="Wrap">
                <Run Text="Add transient databases below. Each will be searched in combination with base databases in the main window."/>
            </TextBlock>
            <TextBlock Margin="0,5,0,5" FontWeight="SemiBold" FontSize="13">
                <Run Text="Current database count: "/>
                <Run Text="{Binding TransientDatabaseCount, Mode=OneWay}"/>
            </TextBlock>
        </StackPanel>

        <!-- Button row -->
        <StackPanel Orientation="Horizontal" Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="2"
                    Margin="5" HorizontalAlignment="Right" Height="20" VerticalAlignment="Bottom">
            <Button x:Name="AddDatabaseButton" 
                    Content="+ADD TRANSIENT DATABASE" 
                    Click="AddDatabaseButton_Click"
                    Style="{StaticResource ImportantButtonStyle}" 
                    Width="180" Margin="0,0,5,0" />
            <Button x:Name="RemoveDatabaseButton"
                    Content="REMOVE SELECTED" 
                    Click="RemoveDatabaseButton_Click"
                    Style="{StaticResource ImportantButtonStyle}" 
                    Width="140" Margin="0,0,5,0" />
            <Button x:Name="ClearDatabasesButton"
                    Content="CLEAR ALL" 
                    Click="ClearDatabasesButton_Click"
                    Style="{StaticResource ImportantButtonStyle}" 
                    Width="100" />
        </StackPanel>

        <!-- Transient databases DataGrid -->
        <DataGrid x:Name="TransientDatabasesDataGrid"
                  Grid.Row="6" Grid.ColumnSpan="2" Grid.Column="0"
                  ItemsSource="{Binding TransientDatabases}"
                  Style="{StaticResource DataGridStyle}"
                  ColumnHeaderStyle="{StaticResource DataGridColumnHeaderStyle}"
                  AllowDrop="True"
                  Drop="TransientDatabaseGrid_Drop"
                  PreviewKeyDown="DataGrid_PreviewKeyDown">
            <DataGrid.RowStyle>
                <Style TargetType="{x:Type DataGridRow}">
                    <Setter Property="FontSize" Value="11" />
                    <Setter Property="FontWeight" Value="SemiBold" />
                </Style>
            </DataGrid.RowStyle>
            <DataGrid.CellStyle>
                <Style TargetType="{x:Type DataGridCell}">
                    <EventSetter Event="MouseDoubleClick" Handler="DataGridCell_DoubleClick"/>
                </Style>
            </DataGrid.CellStyle>
            <DataGrid.Columns>
                <DataGridTextColumn Header="File" Binding="{Binding FileName, Mode=OneWay}"
                                    Width="230" />
                <DataGridTextColumn Header="File Path"
                                    Binding="{Binding FilePath, Mode=OneWay}" Width="200" />
                <DataGridCheckBoxColumn Header="Use?" Binding="{Binding Use, Mode=TwoWay}"
                                        MinWidth="40" />
                <DataGridCheckBoxColumn Header="Contaminant?"
                                        Binding="{Binding Contaminant, Mode=TwoWay}"
                                        MinWidth="90" />
                <DataGridTextColumn Header="Decoy Identifier"
                                    Binding="{Binding DecoyIdentifier, Mode=TwoWay}"
                                    Width="90" />
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</UserControl>
